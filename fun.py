import numpy as np
import pandas as pd
from collections import *
import cPickle
import time

def getOpngram(opcodelist, n=3):
    opngramlist = [tuple(opcodelist[i:i+n]) for i in range(len(opcodelist)-n)]
    opngram = Counter(opngramlist)
    return opngram


baseDir = "E:/msmalware/trainops/"
label = pd.read_csv("E:/msmalware/subtrain40labels2.csv")
# get ops directly from ops file (malware)
opngramMap = {}
count = 1
for id in label.Id:
    filepath = baseDir + id + ".txt"
    f = open(filepath)
    opseq = []
    for line in f:
        opseq.append(line[:-1])
    opngram = getOpngram(opseq)
    print "counting ngram of", count, "file...", opngram
    count += 1
    opngramMap[id] = opngram

print "selecting features..."

sum = Counter()
for feature in opngramMap.values():
    sum += feature
print sum

f = open("E:/log.txt", "a")
print >> f, ""
print >> f, time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(time.time()))
print >> f, "count standard deviation of", len(sum), "ngrams, sub40"
f.close()

# way 3: based on variance
allngrams = sum.keys()
allFeatureList = []
for id, opngram in opngramMap.iteritems():
    featureMap = {}
    featureMap["id"] = id
    for feature in allngrams:
        if feature in opngram:
            featureMap[feature] = opngram[feature]
        else:
            featureMap[feature] = 0
    allFeatureList.append(featureMap)

stdDeviationMap = {}
for feature in allngrams:
    frequencyList = []
    for featureMap in allFeatureList:
        frequencyList.append(featureMap[feature])
    std = np.std(frequencyList)
    stdDeviationMap[feature] = std

f = open("E:/log.txt", "a")
print >> f, time.strftime("End time: %Y-%m-%d %H:%M:%S", time.localtime(time.time()))
f.close()

avg = np.mean(stdDeviationMap.values())
print "number of ngram:", len(allngrams), len(stdDeviationMap), "average standard deviation:", avg

df = pd.DataFrame(stdDeviationMap.items())
df.to_csv("E:/df_to_csv.csv", index=False)
# selectedFeature = []
# for k,v in stdDeviationMap.iteritems():
#     if v > pow(6, 2):
#         selectedFeature.append(k)

