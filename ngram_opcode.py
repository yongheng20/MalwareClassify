from collections import *
import pandas as pd
import re
import numpy as np
import math
import cPickle

def getOpcodeSeq(filepath):
    opcodelist = []
    p = re.compile(r'\s([a-fA-f0-9]{2}\s)+\s*([a-z]+)')
    with open(filepath) as f:
        for line in f:
            if line.startswith(".text"):
                m = re.findall(p, line)
                if m:
                    opcode = m[0][1]
                    if opcode != "align":
                        opcodelist.append(opcode)
    return opcodelist

def getNorOps(filepath):
    f = open(filepath)
    ops = []
    p = re.compile(r'^\s*([a-z]{2,6})\s')
    for line in f:
        m = re.findall(p, line)
        if m:
            opcode = m[0]
            if opcode != "align":
                ops.append(opcode)
    return ops

def getOpngram(opcodelist, n=3):
    opngramlist = [tuple(opcodelist[i:i+n]) for i in range(len(opcodelist)-n)]
    opngram = Counter(opngramlist)
    return opngram

baseDir = "E:/msmalware/trainops/"
trainLabels = pd.read_csv("E:/msmalware/subtrain40labels2.csv")
print trainLabels

opngramMap = {}
count = 1

# get n-gram of each file, restore them in a Id-Counter map
'''
for id in trainLabels.Id:
    filepath = baseDir + id + ".asm"
    opseq = getOpcodeSeq(filepath)
    opngram = getOpngram(opseq)
    # opngram = vn.getVaryNgram(opseq)
    print "counting ngram of", count, "file...", opngram
    count += 1
    # if opngram:
        # cleancount += 1
        # print "cleancount:", cleancount
        # cleanLabels.append(id)
    opngramMap[id] = opngram
'''

'''
for i in range(1, 41):
    filepath = "E:/normalsoftwares/asms/zzasm(" + str(i) + ").asm"
    ops = getNorOps(filepath)
    opngram = getOpngram(ops)
    opngramMap["zzasm(" + str(i) + ")"] = opngram
    print "counting normal file", i, "... length of ops:", len(ops), opngram
'''

# get ops directly from ops file (malware)
'''
for id in trainLabels.Id:
    filepath = baseDir + id + ".txt"
    f = open(filepath)
    opseq = []
    for line in f:
        opseq.append(line[:-1])
    opngram = getOpngram(opseq)
    print "counting ngram of", count, "file...", opngram
    count += 1
    opngramMap[id] = opngram
'''

# get ops directly from ops file (normal software)
'''
for i in range(1, 38):
    filepath = "E:/normalsoftwares/asmops_cp/zzasm(" + str(i) + ").txt"
    f = open(filepath)
    opseq = []
    for line in f:
        opseq.append(line[:-1])
    opngram = getOpngram(opseq)
    opngramMap["zzasm(" + str(i) + ")"] = opngram
    print "counting normal file", i, "... length of ops:", len(opseq), opngram
'''

# cPickle.dump(opngramMap, open("E:/sub40v2opngram.p", "wb"))
opngramMap = cPickle.load(open("E:/sub40v2opngram.p", "rb"))
'''interface: opngramMap'''
print "selecting features..."

'''
sum = Counter()
for feature in opngramMap.values():
    sum += feature
print sum
'''

# df = pd.DataFrame(sum.items(), columns=['ngram', 'count'])
# df.to_csv("E:/sub40v2opngramSum.csv", index=False)
# cPickle.dump(sum, open("E:/sub40v2opngramSum.p", "wb"))
sum = cPickle.load(open("E:/sub40v2opngramSum.p", "rb"))

# way 1: select top n features
'''
topn=50
topFeatures = sum.most_common(topn)
selectedFeature = [topFeatures[i][0] for i in range(0, len(topFeatures))]
'''

# way 2: select features turn up more than 200 times
'''
selectedFeature = []
for k, v in sum.iteritems():
    if v >= 200:
        selectedFeature.append(k)
'''

# way 3: based on standard deviation
'''
allngrams = sum.keys()
allFeatureList = []
for id, opngram in opngramMap.iteritems():
    featureMap = {}
    featureMap["id"] = id
    for feature in allngrams:
        if feature in opngram:
            featureMap[feature] = opngram[feature]
        else:
            featureMap[feature] = 0
    allFeatureList.append(featureMap)

stdDeviationMap = {}
for feature in allngrams:
    frequencyList = []
    for featureMap in allFeatureList:
        frequencyList.append(featureMap[feature])
    std = np.std(frequencyList)
    stdDeviationMap[feature] = std

avg = np.mean(stdDeviationMap.values())
print "number of ngram:", len(stdDeviationMap), "average standard deviation:", avg

selectedFeature = []
for k,v in stdDeviationMap.iteritems():
    if v > 5:
        selectedFeature.append(k)
'''

# way 4: based on information gain
# '''
topn=1500
step=5
featureInfoIncreMap = cPickle.load(open("E:/sub40v2IG_step"+str(step)+".p", "rb"))
# selectedFeature = []
# for k, v in featureInfoIncreMap.iteritems():
#     if v > 0.07:
#         selectedFeature.append(k)
IGlist = [[v[1], v[0]] for v in featureInfoIncreMap.items()]
IGlist.sort(reverse=True)
selectedFeature = [IGlist[i][1] for i in range(topn)]
# '''

'''interface: opngramMap, selectedFeature'''
print selectedFeature
# cPickle.dump(selectedFeature, open("E:/sub40v2_200timesup_selectedFeature.p", "wb"))
print "length of selected features:", len(selectedFeature)

features = []
for id, opngram in opngramMap.iteritems():
    featureMap = {}
    featureMap["Id"] = id
    for feature in selectedFeature:
        if feature in opngram:
            featureMap[feature] = opngram[feature]
        else:
            featureMap[feature] = 0
    features.append(featureMap)
featuresdf = pd.DataFrame(features)
featuresdf.to_csv("E:/msmalware/compare/sub40v2featuresIG(step"+str(step)+")Top"+str(topn)+"_3gram.csv", index=False)
