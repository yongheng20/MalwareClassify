import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier as RFC
from sklearn.metrics import confusion_matrix
import numpy as np
import time
from plot_confusion_matrix import plot_confusion_matrix
import matplotlib.pyplot as plt

step = 5
# topnList = [20,30,50,100,200,400,800,1200,1500,2000,4000]
topnList=[i*2+2 for i in range(15)]

for topn in topnList:
    '''
    featuresPath = ""
    labelsPath = ""
    logMsg = ""
    confusionMtrixClassnames = ""
    confusionMtrixTitle = ""
    '''

    # features = pd.read_csv("E:/msmalware/compare/sub200featuresIGR(step"+str(step)+")Top" + str(topn) + "_3gram.csv")
    # features = pd.read_csv("E:/msmalware/compare/sub200featuresRandom"+str(topn)+"_3gram.csv")
    # features = pd.read_csv("E:/msmalware/compare/sub200featuresWhenLessThan30Top"+str(topn)+"_3gram.csv")
    features = pd.read_csv("E:/msmalware/compare/sub200featuresWhenLessThan30IG(step"+str(step)+")Top"+str(topn)+"_3gram.csv")
    labels = pd.read_csv("E:/msmalware/subtrain200labels.csv")
    
    '''interface: feature, label'''

    train = pd.merge(labels, features, on="Id")

    labels = train.Class
    train.drop(["Id", "Class"], axis=1, inplace=True)
    train = train.as_matrix()

    '''interface: labels, train'''
    f = open("E:/log.txt", "a")
    print >> f, ""
    print >> f, time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(time.time()))
    print >> f, "[sub200, malware classify] [opcode 3 gram] [select features sub200 IG(step"+str(step)+") top " + str(topn) \
                + "] [test size=0.3] [randomforest classifier with 100 trees]"
    f.close()

    scoreList = []
    n = 50
    confusionMtrix = np.array(np.int32())
    for i in range(n):
        X_train, X_test, y_train, y_test = train_test_split(train, labels, test_size=0.3)
        rfc = RFC(n_estimators=100, n_jobs=-1)
        rfc.fit(X_train, y_train)
        scoreList.append(rfc.score(X_test, y_test))
        y_pred = rfc.predict(X_test)

        if len(confusionMtrix.shape) == 0:
            confusionMtrix = confusion_matrix(y_test, y_pred)
        else:
            confusionMtrix += confusion_matrix(y_test, y_pred)

    confusionMtrix = confusionMtrix / np.float64(n)

    '''result: scoreList, confusionMtrix'''
    f = open("E:/log.txt", "a")
    avg = np.mean(scoreList)
    for i in range(len(scoreList)):
        scoreList[i] = round(scoreList[i], 4)
    print >> f, "scores in", len(scoreList), "rounds:", scoreList
    print >> f, "avg score:", round(avg, 5)
    print >> f, time.strftime("End time: %Y-%m-%d %H:%M:%S", time.localtime(time.time()))
    f.close()

    # classnames = ['normal software', 'class 1','class 2','class 3','class 4','class 5', 'class 6','class 7','class 8','class 9']
    classnames = ['class 1','class 2','class 3','class 4','class 5', 'class 6','class 7','class 8','class 9']
    # classnames = ['normal software', 'malware']
    plt.figure(figsize=(10, 6), dpi=80)
    plot_confusion_matrix(confusionMtrix, classnames,
                              title='Malware Classify Confusion Matrix\nAverage value in ' + str(n) + ' rounds\n'
                                    + '(features: sub200 top' + str(topn) + ', average accrucy: '+str(round(avg, 5))+')')
    # '(features: sub200 IGR(step' + str(step) + ') top' + str(topn) + ', average accrucy:'
    print confusionMtrix
